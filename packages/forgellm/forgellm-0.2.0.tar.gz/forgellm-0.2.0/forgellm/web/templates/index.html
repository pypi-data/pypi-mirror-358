<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MLX Training Interface</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <!-- Plotly -->
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <!-- Socket.IO -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
    
    <style>
        :root {
            --primary-color: #2E86AB;
            --secondary-color: #A23B72;
            --success-color: #28a745;
            --warning-color: #ffc107;
            --danger-color: #dc3545;
            --info-color: #17a2b8;
            --light-color: #f8f9fa;
            --dark-color: #343a40;
        }
        
        body {
            background-color: var(--light-color);
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        .navbar {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .navbar-brand {
            font-weight: bold;
            font-size: 1.5rem;
        }
        
        .card {
            border: none;
            border-radius: 15px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            transition: transform 0.2s ease;
        }
        
        .card:hover {
            transform: translateY(-2px);
        }
        
        .card-header {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            border-radius: 15px 15px 0 0 !important;
            font-weight: bold;
        }
        
        .nav-tabs .nav-link {
            border: none;
            border-radius: 10px 10px 0 0;
            margin-right: 5px;
            font-weight: 500;
        }
        
        .nav-tabs .nav-link.active {
            background: var(--primary-color);
            color: white;
        }
        
        .btn-primary {
            background: var(--primary-color);
            border-color: var(--primary-color);
            border-radius: 10px;
            font-weight: 500;
        }
        
        .btn-success {
            background: var(--success-color);
            border-color: var(--success-color);
            border-radius: 10px;
        }
        
        .btn-danger {
            background: var(--danger-color);
            border-color: var(--danger-color);
            border-radius: 10px;
        }
        
        .form-control, .form-select {
            border-radius: 10px;
            border: 2px solid #e9ecef;
            transition: border-color 0.2s ease;
        }
        
        .form-control:focus, .form-select:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 0.2rem rgba(46, 134, 171, 0.25);
        }
        
        .progress {
            height: 25px;
            border-radius: 15px;
            background-color: #e9ecef;
        }
        
        .progress-bar {
            border-radius: 15px;
            background: linear-gradient(90deg, var(--success-color), var(--primary-color));
        }
        
        .metric-card {
            background: white;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            text-align: center;
        }
        
        .metric-value {
            font-size: 2rem;
            font-weight: bold;
            color: var(--primary-color);
        }
        
        .metric-label {
            color: var(--dark-color);
            font-size: 0.9rem;
            margin-top: 5px;
        }
        
        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 8px;
        }
        
        .status-running { background-color: var(--success-color); }
        .status-stopped { background-color: var(--danger-color); }
        .status-completed { background-color: var(--info-color); }
        
        .chart-container {
            background: white;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }
        
        .loading-spinner {
            display: none;
            text-align: center;
            padding: 20px;
        }
        
        .alert {
            border-radius: 10px;
            border: none;
        }
        
        .checkpoint-item {
            background: white;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 10px;
            border-left: 4px solid var(--primary-color);
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        
        .checkpoint-rank {
            background: var(--primary-color);
            color: white;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            margin-right: 10px;
        }
        
        .generation-output {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 15px;
            font-family: 'Courier New', monospace;
            white-space: pre-wrap;
            max-height: 400px;
            overflow-y: auto;
        }

        /* iPhone-like chat styling */
        .chat-user {
            background: linear-gradient(135deg, #007AFF, #5AC8FA) !important;
            color: white !important;
            border-radius: 20px 20px 6px 20px !important;
            margin: 6px 0 6px auto !important;
            max-width: 70% !important;
            padding: 14px 18px !important;
            border: none !important;
            box-shadow: 0 2px 8px rgba(0, 122, 255, 0.2) !important;
            font-size: 15px !important;
            line-height: 1.45 !important;
            word-wrap: break-word !important;
            font-weight: 400 !important;
        }

        .chat-assistant {
            background: white !important;
            color: #1c1c1e !important;
            border-radius: 20px 20px 20px 6px !important;
            margin: 6px auto 6px 0 !important;
            max-width: 80% !important;
            padding: 14px 18px !important;
            border: 1px solid #e5e5ea !important;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.08) !important;
            font-size: 15px !important;
            line-height: 1.45 !important;
            word-wrap: break-word !important;
            font-weight: 400 !important;
        }

        /* Chat container styling */
        #chat-history {
            background: linear-gradient(to bottom, #f8f9fa, #ccc4c4) !important;
            padding: 20px 16px !important;
            border-radius: 0 !important;
        }

        #chat-history .list-group-item:first-child {
            border-top-left-radius: 0 !important;
            border-top-right-radius: 0 !important;
        }

        #chat-history .list-group-item:last-child {
            border-bottom-left-radius: 0 !important;
            border-bottom-right-radius: 0 !important;
        }

        /* Improve the Generation Output card */
        .card {
            border-radius: 12px !important;
            box-shadow: 0 2px 12px rgba(0, 0, 0, 0.08) !important;
            border: 1px solid #e5e5ea !important;
        }

        .card-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%) !important;
            color: white !important;
            border-radius: 12px 12px 0 0 !important;
            border-bottom: none !important;
            padding: 16px 20px !important;
            font-weight: 600 !important;
        }



        .card-body {
            border-radius: 0 0 12px 12px !important;
        }

        /* Chat input styling */
        #chat-input-container {
            background: white !important;
            border-top: 1px solid #E5E5EA !important;
            padding: 16px 20px !important;
        }

        #chat-input {
            border-radius: 24px !important;
            border: 2px solid #e5e5ea !important;
            padding: 12px 18px !important;
            font-size: 15px !important;
            background: #f8f9fa !important;
            transition: all 0.2s ease !important;
            resize: none !important;
        }

        #chat-input:focus {
            border-color: #007AFF !important;
            box-shadow: 0 0 0 3px rgba(0, 122, 255, 0.1) !important;
            background: white !important;
            outline: none !important;
        }

        #send-message-btn {
            border-radius: 50% !important;
            width: 44px !important;
            height: 44px !important;
            margin-left: 10px !important;
            background: linear-gradient(135deg, #007AFF, #5AC8FA) !important;
            border: none !important;
            display: flex !important;
            align-items: center !important;
            justify-content: center !important;
            transition: all 0.2s ease !important;
            box-shadow: 0 2px 8px rgba(0, 122, 255, 0.3) !important;
        }

        #send-message-btn:hover {
            background: linear-gradient(135deg, #0056CC, #4A9EE8) !important;
            transform: translateY(-1px) !important;
            box-shadow: 0 4px 12px rgba(0, 122, 255, 0.4) !important;
        }

        #send-message-btn:disabled {
            background: #C7C7CC !important;
            transform: none !important;
            box-shadow: none !important;
        }

        /* Toolbar styling */
        .btn-group .btn {
            border-radius: 8px !important;
            margin-right: 6px !important;
            font-size: 13px !important;
            padding: 6px 12px !important;
            font-weight: 500 !important;
            transition: all 0.2s ease !important;
        }

        .btn-outline-secondary:hover {
            background: #6c757d !important;
            border-color: #6c757d !important;
            transform: translateY(-1px) !important;
        }

        .btn-outline-primary:hover {
            background: #007AFF !important;
            border-color: #007AFF !important;
            transform: translateY(-1px) !important;
        }

        .btn-outline-success:hover {
            background: #28a745 !important;
            border-color: #28a745 !important;
            transform: translateY(-1px) !important;
        }

        /* Markdown content in chat messages */
        .chat-assistant h1, .chat-assistant h2, .chat-assistant h3, 
        .chat-assistant h4, .chat-assistant h5, .chat-assistant h6 {
            margin-top: 18px !important;
            margin-bottom: 10px !important;
            font-weight: 700 !important;
            color: #2c3e50 !important;
        }

        .chat-assistant h1:first-child, .chat-assistant h2:first-child, 
        .chat-assistant h3:first-child, .chat-assistant h4:first-child, 
        .chat-assistant h5:first-child, .chat-assistant h6:first-child {
            margin-top: 0 !important;
        }

        .chat-assistant h1 { font-size: 20px !important; }
        .chat-assistant h2 { font-size: 18px !important; }
        .chat-assistant h3 { font-size: 16px !important; }

        .chat-assistant p {
            margin-bottom: 14px !important;
            color: #1c1c1e !important;
        }

        .chat-assistant p:last-child {
            margin-bottom: 0 !important;
        }

        .chat-assistant ul, .chat-assistant ol {
            margin: 10px 0 !important;
            padding-left: 22px !important;
        }

        .chat-assistant li {
            margin-bottom: 6px !important;
            color: #1c1c1e !important;
        }

        .chat-assistant code {
            background: #f1f3f4 !important;
            color: #d73a49 !important;
            padding: 3px 8px !important;
            border-radius: 6px !important;
            font-family: 'SF Mono', 'Monaco', 'Inconsolata', 'Roboto Mono', monospace !important;
            font-size: 13px !important;
            font-weight: 500 !important;
        }

        .chat-assistant pre {
            background: #f8f9fa !important;
            border: 1px solid #e9ecef !important;
            padding: 16px !important;
            border-radius: 10px !important;
            margin: 16px 0 !important;
            overflow-x: auto !important;
        }

        .chat-assistant pre code {
            background: none !important;
            color: #24292e !important;
            padding: 0 !important;
            font-weight: 400 !important;
        }

        .chat-assistant blockquote {
            border-left: 4px solid #007AFF !important;
            background: #f8f9ff !important;
            padding: 12px 16px !important;
            margin: 16px 0 !important;
            border-radius: 0 8px 8px 0 !important;
            color: #495057 !important;
            font-style: italic !important;
        }

        .chat-assistant strong {
            color: #2c3e50 !important;
            font-weight: 600 !important;
        }

        .chat-assistant em {
            color: #6c757d !important;
        }

        /* Welcome message styling */
        #chat-welcome {
            background: rgba(255, 255, 255, 0.8) !important;
            border-radius: 16px !important;
            padding: 40px 20px !important;
            margin: 20px !important;
            backdrop-filter: blur(10px) !important;
            border: 1px solid rgba(229, 229, 234, 0.5) !important;
        }

        #chat-welcome i {
            opacity: 0.6 !important;
        }

        #chat-welcome p {
            color: #8e8e93 !important;
            font-size: 16px !important;
            margin: 0 !important;
            font-weight: 400 !important;
        }

        /* Stats display */
        #chat-stats {
            background: rgba(255, 255, 255, 0.9) !important;
            padding: 8px 12px !important;
            border-radius: 8px !important;
            font-size: 12px !important;
            color: #6c757d !important;
            border: 1px solid rgba(229, 229, 234, 0.5) !important;
        }

        /* Toolbar container */
        .d-flex.justify-content-between.align-items-center.px-3.py-2.border-bottom {
            background: rgba(248, 249, 250, 0.95) !important;
            backdrop-filter: blur(10px) !important;
            border-bottom: 1px solid #e5e5ea !important;
        }

        /* Scrollbar styling for chat */
        #chat-history::-webkit-scrollbar {
            width: 6px;
        }

        #chat-history::-webkit-scrollbar-track {
            background: transparent;
        }

        #chat-history::-webkit-scrollbar-thumb {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 3px;
        }

        #chat-history::-webkit-scrollbar-thumb:hover {
            background: rgba(0, 0, 0, 0.3);
        }

        .mt-4 {
            max-width: 85%;
        }
        
        /* Chat input auto-resize */
        #chat-input {
            min-height: 38px;
            max-height: 120px;
            transition: height 0.1s ease;
        }
        
        #chat-input:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 0.2rem rgba(46, 134, 171, 0.25);
        }
        
        #chat-input-container {
            background: #f8f9fa;
        }

        /* Compact chat bubbles */
        #chat-history .list-group-item {
            border: none;               /* remove list-group default border */
            padding: .6rem .8rem;       /* tighter padding */
            margin-bottom: .3rem;       /* small gap between bubbles */
            border-radius: .5rem;
        }
        #chat-history .chat-user {
            background: #dee2e6;        /* light grey */
            text-align: right;
        }
        #chat-history .chat-assistant {
            background: #d0e4ff;        /* light blue */
            text-align: left;
        }
        
        /* Markdown formatting styles */
        #chat-history .chat-assistant h1,
        #chat-history .chat-assistant h2,
        #chat-history .chat-assistant h3,
        #chat-history .chat-assistant h4,
        #chat-history .chat-assistant h5,
        #chat-history .chat-assistant h6 {
            margin-top: 0.5rem;
            margin-bottom: 0.5rem;
            font-weight: 600;
        }
        
        #chat-history .chat-assistant h1 { font-size: 1.5rem; }
        #chat-history .chat-assistant h2 { font-size: 1.4rem; }
        #chat-history .chat-assistant h3 { font-size: 1.3rem; }
        #chat-history .chat-assistant h4 { font-size: 1.2rem; }
        #chat-history .chat-assistant h5 { font-size: 1.1rem; }
        #chat-history .chat-assistant h6 { font-size: 1rem; }
        
        #chat-history .chat-assistant pre {
            margin: 0.5rem 0;
            max-width: 100%;
            overflow-x: auto;
        }
        
        #chat-history .chat-assistant code {
            font-family: 'Courier New', monospace;
        }
        
        #chat-history .chat-assistant ul,
        #chat-history .chat-assistant ol {
            margin: 0.5rem 0;
            padding-left: 1.5rem;
        }
        
        #chat-history .chat-assistant blockquote {
            margin: 0.5rem 0;
        }
        
        #chat-history .chat-assistant p {
            margin: 0.5rem 0;
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark">
        <div class="container">
            <a class="navbar-brand" href="#">
                <i class="fas fa-brain me-2"></i>MLX Training Interface
            </a>
            <div class="navbar-nav ms-auto">
                <span class="navbar-text" id="connection-status">
                    <span class="status-indicator status-stopped"></span>
                    Connecting...
                </span>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="container mt-4">
        <!-- Tabs -->
        <ul class="nav nav-tabs mb-4" id="mainTabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="training-tab" data-bs-toggle="tab" data-bs-target="#training" type="button" role="tab">
                    <i class="fas fa-play me-2"></i>Training
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="monitoring-tab" data-bs-toggle="tab" data-bs-target="#monitoring" type="button" role="tab">
                    <i class="fas fa-chart-line me-2"></i>Monitoring
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="testing-tab" data-bs-toggle="tab" data-bs-target="#testing" type="button" role="tab">
                    <i class="fas fa-flask me-2"></i>Testing
                </button>
            </li>
        </ul>

        <!-- Tab Content -->
        <div class="tab-content" id="mainTabContent">
            <!-- Training Tab -->
            <div class="tab-pane fade show active" id="training" role="tabpanel">
                <div class="row">
                    <div class="col-lg-8">
                        <div class="card">
                            <div class="card-header">
                                <i class="fas fa-cog me-2"></i>Training Configuration
                            </div>
                            <div class="card-body">
                                <form id="training-form">
                                    <div class="row">
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label for="model-select" class="form-label">Model</label>
                                                <select class="form-select" id="model-select" required>
                                                    <option value="">Loading models...</option>
                                                </select>
                                            </div>
                                        </div>
                                        <div class="col-md-3">
                                            <div class="mb-3">
                                                <label for="input-dir" class="form-label">Training Dataset</label>
                                                <div class="input-group">
                                                    <input type="text" class="form-control" id="input-dir" value="dataset" required readonly>
                                                    <button type="button" class="btn btn-outline-primary" id="browse-input-dir">
                                                        <i class="fas fa-folder-open"></i>
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-md-3">
                                            <div class="mb-3">
                                                <label for="output-dir" class="form-label">Output Directory</label>
                                                <div class="input-group">
                                                    <input type="text" class="form-control" id="output-dir" value="models" required readonly>
                                                    <button type="button" class="btn btn-outline-primary" id="browse-output-dir">
                                                        <i class="fas fa-folder-open"></i>
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="row">
                                        <div class="col-md-3">
                                            <div class="mb-3">
                                                <label for="batch-size" class="form-label">Batch Size</label>
                                                <input type="number" class="form-control" id="batch-size" value="6" required min="1">
                                            </div>
                                        </div>
                                        <div class="col-md-3">
                                            <div class="mb-3">
                                                <label for="learning-rate" class="form-label">Learning Rate</label>
                                                <input type="text" class="form-control" id="learning-rate" value="3e-6" required>
                                            </div>
                                        </div>
                                        <div class="col-md-3">
                                            <div class="mb-3">
                                                <label for="max-iterations" class="form-label">Max Iterations</label>
                                                <input type="number" class="form-control" id="max-iterations" value="300" required min="1">
                                            </div>
                                        </div>
                                        <div class="col-md-3">
                                            <div class="mb-3">
                                                <label for="warmup-steps" class="form-label">Warmup Steps</label>
                                                <input type="number" class="form-control" id="warmup-steps" value="30" required min="0">
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="row">
                                        <div class="col-md-4">
                                            <div class="mb-3">
                                                <label for="max-seq-length" class="form-label">Max Sequence Length</label>
                                                <input type="number" class="form-control" id="max-seq-length" value="2048" min="512" max="8192" step="512" required>
                                            </div>
                                        </div>
                                        <div class="col-md-4">
                                            <div class="mb-3">
                                                <label for="weight-decay" class="form-label">Weight Decay</label>
                                                <input type="number" class="form-control" id="weight-decay" value="0.01" step="0.001" min="0" max="0.1" required>
                                            </div>
                                        </div>
                                        <div class="col-md-4">
                                            <div class="mb-3">
                                                <label for="lr-decay-factor" class="form-label">LR Decay Factor</label>
                                                <input type="number" class="form-control" id="lr-decay-factor" value="0.1" step="0.01" min="0.01" max="1.0" required>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="row">
                                        <div class="col-md-4">
                                            <div class="mb-3">
                                                <label for="fine-tune-type" class="form-label">Fine-tuning Type</label>
                                                <select class="form-select" id="fine-tune-type" required>
                                                    <option value="full" selected>Full (all parameters)</option>
                                                    <option value="lora">LoRA</option>
                                                    <option value="dora">DoRA</option>
                                                </select>
                                                <small class="form-text text-muted">Full trains all parameters, LoRA/DoRA use parameter-efficient methods</small>
                                            </div>
                                        </div>
                                        <div class="col-md-4">
                                            <div class="mb-3">
                                                <label for="num-layers" class="form-label">Layers to Fine-tune</label>
                                                <input type="number" class="form-control" id="num-layers" value="-1" min="-1" max="100" step="1" required>
                                                <small class="form-text text-muted">Use -1 for all layers or specify number (for LoRA/DoRA)</small>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="row">
                                        <div class="col-md-4">
                                            <div class="mb-3">
                                                <label for="lr-schedule" class="form-label">LR Schedule</label>
                                                <select class="form-select" id="lr-schedule" required>
                                                    <option value="cosine_decay">Cosine Decay</option>
                                                    <option value="linear_decay">Linear Decay</option>
                                                    <option value="constant">Constant</option>
                                                </select>
                                            </div>
                                        </div>
                                        <div class="col-md-3">
                                            <div class="mb-3">
                                                <label for="save-every" class="form-label">Save Every X Steps</label>
                                                <select class="form-select" id="save-every" required>
                                                    <option value="5">5 steps</option>
                                                    <option value="10">10 steps</option>
                                                    <option value="25">25 steps</option>
                                                    <option value="50" selected>50 steps</option>
                                                    <option value="100">100 steps</option>
                                                </select>
                                            </div>
                                        </div>
                                        <div class="col-md-3">
                                            <div class="mb-3">
                                                <label for="eval-every" class="form-label">Eval Every X Steps</label>
                                                <select class="form-select" id="eval-every" required>
                                                    <option value="5">5</option>
                                                    <option value="10">10</option>
                                                    <option value="25" selected>25</option>
                                                    <option value="50">50</option>
                                                    <option value="100">100</option>
                                                </select>
                                            </div>
                                        </div>
                                        <div class="col-md-3">
                                            <div class="mb-3">
                                                <label for="val-fast-pct" class="form-label">Quick Val %</label>
                                                <input type="number" class="form-control" id="val-fast-pct" value="1.0" step="0.01" min="0.05" max="1" required>
                                                <small class="form-text text-muted">Percentage of validation set used for quick checks</small>
                                            </div>
                                        </div>
                                        <div class="col-md-3">
                                            <div class="mb-3">
                                                <label for="validation-split" class="form-label">Validation Split</label>
                                                <input type="number" class="form-control" id="validation-split" value="0.1" step="0.01" min="0.05" max="0.3" required>
                                                <small class="form-text text-muted">Fraction of data used for validation</small>
                                            </div>
                                        </div>
                                        <div class="col-md-3">
                                            <div class="mb-3">
                                                <div class="form-check mt-4">
                                                    <!-- Early stopping is disabled by default. Users can enable it here. -->
                                                    <input class="form-check-input" type="checkbox" id="enable-early-stopping">
                                                    <label class="form-check-label" for="enable-early-stopping">
                                                        Enable Early Stopping
                                                    </label>
                                                    <small class="form-text text-muted">When enabled, training stops if validation loss stops improving (disabled by default)</small>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Training Estimates -->
                                    <div class="row">
                                        <div class="col-12">
                                            <div class="alert alert-info" id="training-estimates">
                                                <i class="fas fa-calculator me-2"></i>
                                                <strong>Training Estimates:</strong>
                                                <span id="epoch-estimate">Configure parameters to see estimates</span>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Learning Rate Schedule Preview -->
                                    <div class="row mt-3">
                                        <div class="col-12">
                                            <div class="card mb-4">
                                                <div class="card-header">
                                                    <i class="fas fa-chart-line me-2"></i>Learning Rate Schedule Preview
                                                </div>
                                                <div class="card-body">
                                                    <div id="lr-schedule-chart" style="height: 300px;"></div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                                        <button type="button" class="btn btn-danger me-md-2" id="stop-training-btn" disabled>
                                            <i class="fas fa-stop me-2"></i>Stop Training
                                        </button>
                                        <button type="submit" class="btn btn-primary" id="start-training-btn">
                                            <i class="fas fa-play me-2"></i>Start Training
                                        </button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-lg-4">
                        <div class="card">
                            <div class="card-header">
                                <i class="fas fa-info-circle me-2"></i>Training Status
                            </div>
                            <div class="card-body">
                                <div id="training-status">
                                    <div class="text-center text-muted">
                                        <i class="fas fa-clock fa-2x mb-3"></i>
                                        <p>No training in progress</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="card mt-3">
                            <div class="card-header">
                                <i class="fas fa-graduation-cap me-2"></i>Training Sessions
                            </div>
                            <div class="card-body">
                                <div id="checkpoints-list">
                                    <div class="text-center text-muted">
                                        <i class="fas fa-folder-open fa-2x mb-3"></i>
                                        <p>Loading checkpoints...</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Monitoring Tab -->
            <div class="tab-pane fade" id="monitoring" role="tabpanel">
                <div class="row">
                    <!-- Training Session Selection -->
                    <div class="col-12 mb-4">
                        <div class="card">
                            <div class="card-header">
                                <i class="fas fa-history me-2"></i>Training Session
                            </div>
                            <div class="card-body">
                                <div class="row align-items-end">
                                    <div class="col-md-8">
                                        <label for="training-session-select" class="form-label">Select Training Session</label>
                                        <select class="form-select" id="training-session-select">
                                            <option value="">Current training session</option>
                                        </select>
                                    </div>
                                                        <div class="col-md-4 d-flex gap-2">
                        <button type="button" class="btn btn-primary flex-grow-1" id="load-session-btn">
                            <i class="fas fa-eye me-2"></i>View Session
                        </button>
                        <button type="button" class="btn btn-outline-info" id="view-logs-btn" title="View session logs">
                            <i class="fas fa-file-code"></i>
                        </button>
                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Key Metrics -->
                    <div class="col-12">
                        <div class="row" id="metrics-row">
                            <div class="col-md-2">
                                <div class="metric-card">
                                    <div class="metric-value" id="current-iteration">-</div>
                                    <div class="metric-label">Iteration</div>
                                </div>
                            </div>
                            <div class="col-md-2">
                                <div class="metric-card">
                                    <div class="metric-value" id="train-loss">-</div>
                                    <div class="metric-label">Train Loss</div>
                                </div>
                            </div>
                            <div class="col-md-2">
                                <div class="metric-card">
                                    <div class="metric-value" id="val-loss">-</div>
                                    <div class="metric-label">Val Loss</div>
                                </div>
                            </div>
                            <div class="col-md-2">
                                <div class="metric-card">
                                    <div class="metric-value" id="perplexity">-</div>
                                    <div class="metric-label">Perplexity</div>
                                </div>
                            </div>
                            <div class="col-md-2">
                                <div class="metric-card">
                                    <div class="metric-value" id="tokens-per-sec">-</div>
                                    <div class="metric-label">Tokens/sec</div>
                                </div>
                            </div>
                            <div class="col-md-2">
                                <div class="metric-card">
                                    <div class="metric-value" id="trained-tokens">-</div>
                                    <div class="metric-label">Trained Tokens</div>
                                </div>
                            </div>
                            <div class="col-md-2">
                                <div class="metric-card">
                                    <div class="metric-value" id="epoch-done">-</div>
                                    <div class="metric-label">Epoch</div>
                                </div>
                            </div>
                            <div class="col-md-2">
                                <div class="metric-card">
                                    <div class="metric-value" id="memory-usage">-</div>
                                    <div class="metric-label">Memory (GB)</div>
                                </div>
                            </div>
                            <div class="col-md-2">
                                <div class="metric-card">
                                                                    <div class="metric-value" id="display-learning-rate">-</div>
                                <div class="metric-label">Learning Rate</div>
                            </div>
                        </div>
                        <div class="col-md-2">
                            <div class="metric-card">
                                <div class="metric-value" id="display-warmup-steps">-</div>
                                <div class="metric-label">Warmup Steps</div>
                            </div>
                        </div>
                        <div class="col-md-2">
                            <div class="metric-card">
                                <div class="metric-value" id="display-lr-decay-factor">-</div>
                                <div class="metric-label">LR Decay</div>
                            </div>
                        </div>
                        <div class="col-md-2">
                            <div class="metric-card">
                                <div class="metric-value" id="display-weight-decay">-</div>
                                <div class="metric-label">Weight Decay</div>
                            </div>
                        </div>
                        </div>
                    </div>
                    
                    <!-- Progress Bar -->
                    <div class="col-12 mb-4">
                        <div class="card">
                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <span>Training Progress</span>
                                    <div class="d-flex align-items-center gap-3">
                                        <span id="elapsed-time" class="text-muted small">E.Time: --</span>
                                        <span id="eta-time" class="text-muted small">R.Time: --</span>
                                        <span id="progress-text">0%</span>
                                    </div>
                                </div>
                                <div class="progress">
                                    <div class="progress-bar" id="progress-bar" role="progressbar" style="width: 0%"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Charts -->
                    <div class="col-lg-6">
                        <div class="chart-container">
                            <div id="loss-chart"></div>
                        </div>
                    </div>
                    <div class="col-lg-6">
                        <div class="chart-container">
                            <div id="perplexity-chart"></div>
                        </div>
                    </div>
                    <div class="col-lg-6">
                        <div class="chart-container">
                            <div id="lr-chart"></div>
                        </div>
                    </div>
                    <div class="col-lg-6">
                        <div class="chart-container">
                            <div id="speed-chart"></div>
                        </div>
                    </div>
                    
                    <!-- Best Checkpoints -->
                    <div class="col-12">
                        <div class="card">
                            <div class="card-header">
                                <i class="fas fa-trophy me-2"></i>Top 3 Best Checkpoints
                            </div>
                            <div class="card-body">
                                <div id="best-checkpoints">
                                    <div class="text-center text-muted">
                                        <i class="fas fa-chart-line fa-2x mb-3"></i>
                                        <p>No training data available</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- All Checkpoints Selection -->
                    <div class="col-12 mt-3">
                        <div class="card">
                            <div class="card-header">
                                <i class="fas fa-list-alt me-2"></i>All Available Checkpoints
                            </div>
                            <div class="card-body">
                                <div class="row align-items-end">
                                    <div class="col-md-8">
                                        <label for="checkpoint-select" class="form-label">Select Checkpoint to Publish</label>
                                        <select class="form-select" id="checkpoint-select">
                                            <option value="">Select a checkpoint...</option>
                                        </select>
                                    </div>
                                    <div class="col-md-4">
                                        <button type="button" class="btn btn-primary w-100" id="publish-selected-checkpoint-btn">
                                            <i class="fas fa-cloud-upload-alt me-2"></i>Publish Selected Checkpoint
                                        </button>
                                    </div>
                                </div>
                                <div class="mt-3 small text-muted">
                                    <i class="fas fa-info-circle me-1"></i>
                                    This list shows all available checkpoints for the selected training session.
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Testing Tab -->
            <div class="tab-pane fade" id="testing" role="tabpanel">
                <div class="row">
                    <div class="col-lg-4">
                        <div class="card">
                            <div class="card-header">
                                <i class="fas fa-cogs me-2"></i>Model Configuration
                            </div>
                            <div class="card-body">
                                <form id="model-load-form">
                                    <div class="mb-3">
                                        <label for="test-model-select" class="form-label">Base Model</label>
                                        <div class="input-group">
                                            <select class="form-select" id="test-model-select" required>
                                                <option value="">Select model...</option>
                                            </select>
                                            <button class="btn btn-outline-secondary" type="button" id="copy-model-path-btn" title="Copy full model path">
                                                <i class="fas fa-copy"></i>
                                            </button>
                                            <button class="btn btn-outline-primary" type="button" id="open-model-folder-btn" title="Open model folder (only works when server and client are on the same machine)">
                                                <i class="fas fa-folder-open"></i>
                                            </button>
                                            <button class="btn btn-outline-info" type="button" id="view-dashboard-btn" title="View training dashboard" disabled>
                                                <i class="fas fa-chart-line"></i>
                                            </button>
                                        </div>
                                    </div>
                                    <div class="mb-3">
                                        <label for="adapter-path" class="form-label">Adapter Path (Optional)</label>
                                        <div class="input-group">
                                            <select class="form-select" id="adapter-path">
                                                <option value="">No adapter (base model only)</option>
                                            </select>
                                            <button class="btn btn-outline-secondary" type="button" id="copy-adapter-path-btn" title="Copy full adapter path">
                                                <i class="fas fa-copy"></i>
                                            </button>
                                        </div>
                                    </div>
                                    <div class="mb-3">
                                        <label for="system-prompt" class="form-label">System Prompt</label>
                                        <textarea class="form-control" id="system-prompt" rows="2" placeholder="Optional system prompt to guide model behavior..."></textarea>
                                    </div>
                                    
                                    <!-- Generation Parameters Section -->
                                    <div class="mb-3">
                                        <label class="form-label">Generation Parameters</label>
                                        <div class="row g-2 mb-2">
                                            <div class="col-md-6">
                                                <label for="max-tokens" class="form-label small">Max Tokens</label>
                                                <input type="number" class="form-control" id="max-tokens" value="2000" min="1" required>
                                            </div>
                                            <div class="col-md-6">
                                                <label for="max-kv-size" class="form-label small">Context Window</label>
                                                <select class="form-select" id="max-kv-size">
                                                    <option value="512">512</option>
                                                    <option value="1024">1K (1,024)</option>
                                                    <option value="2048">2K (2,048)</option>
                                                    <option value="4096">4K (4,096)</option>
                                                    <option value="8192">8K (8,192)</option>
                                                    <option value="16384" selected>16K (16,384)</option>
                                                    <option value="32768">32K (32,768)</option>
                                                    <option value="65536">64K (65,536)</option>
                                                    <option value="131072">128K (131,072)</option>
                                                </select>
                                            </div>
                                        </div>
                                        <div class="row g-2 mb-2">
                                            <div class="col-md-4">
                                                <div class="input-group input-group-sm">
                                                    <span class="input-group-text">Temperature</span>
                                                    <input type="number" class="form-control" id="temperature" value="0.7" min="0.0" max="2.0" step="0.1">
                                                </div>
                                            </div>
                                            <div class="col-md-4">
                                                <div class="input-group input-group-sm">
                                                    <span class="input-group-text">Top P</span>
                                                    <input type="number" class="form-control" id="top-p" value="0.9" min="0.0" max="1.0" step="0.05">
                                                </div>
                                            </div>
                                            <div class="col-md-4">
                                                <div class="input-group input-group-sm">
                                                    <span class="input-group-text">Rep. Penalty</span>
                                                    <input type="number" class="form-control" id="repetition-penalty" value="1.1" min="1.0" max="2.0" step="0.05">
                                                </div>
                                            </div>
                                        </div>
                                        <div class="row g-2">
                                            <div class="col-md-6">
                                                <div class="form-check form-switch">
                                                                                    <input class="form-check-input" type="checkbox" id="streaming-toggle" checked>
                                <label class="form-check-label" for="streaming-toggle">
                                                        <i class="fas fa-stream me-1"></i>Real-time Streaming
                                                    </label>
                                                </div>
                                            </div>
                                            <div class="col-md-6">
                                                <small class="text-muted">
                                                    <i class="fas fa-info-circle me-1"></i>Shows text as it's generated
                                                </small>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                                        <button type="button" class="btn btn-danger me-md-2" id="unload-model-btn" disabled>
                                            <i class="fas fa-times me-2"></i>Unload Model
                                        </button>
                                        <button type="submit" class="btn btn-primary" id="load-model-btn">
                                            <i class="fas fa-download me-2"></i>Load Model
                                        </button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-lg-8">
                        <div class="card">
                            <div class="card-header">
                                <i class="fas fa-terminal me-2"></i>Generation Output
                            </div>
                            <div class="card-body p-0">
                                <!-- Toolbar -->
                                <div class="d-flex justify-content-between align-items-center px-3 py-2 border-bottom">
                                    <div class="btn-group" role="group" aria-label="Chat toolbar">
                                        <button id="clear-chat-btn" class="btn btn-sm btn-outline-secondary" disabled>
                                            <i class="fas fa-trash"></i> Clear
                                        </button>
                                        <button id="toggle-chat-btn" class="btn btn-sm btn-outline-secondary" data-bs-toggle="tooltip" title="Toggle chat history for context (on by default)">
                                            <i class="fas fa-book-open"></i> History: On
                                        </button>
                                        <button id="toggle-markdown-btn" class="btn btn-sm btn-outline-primary d-none" data-bs-toggle="tooltip" title="Toggle markdown rendering (on by default)">
                                            <i class="fab fa-markdown"></i> Markdown: On
                                        </button>
                                        <button id="save-chat-btn" class="btn btn-sm btn-outline-primary" disabled data-bs-toggle="tooltip" title="Saves conversation with model metadata">
                                            <i class="fas fa-save"></i> Save History <i class="fas fa-tag small"></i>
                                        </button>
                                        <button id="load-chat-btn" class="btn btn-sm btn-outline-success" data-bs-toggle="tooltip" title="Load previously saved conversation">
                                            <i class="fas fa-upload"></i> Load History
                                        </button>
                                    </div>
                                    <small id="chat-stats" class="text-muted text-end" style="text-align: right; line-height: 1.2;"></small>
                                </div>

                                <!-- Chat history -->
                                <div id="chat-history" class="list-group overflow-auto" style="height:60vh;">
                                    <!-- Welcome message when no chat history -->
                                    <div class="d-flex flex-column align-items-center justify-content-center h-100 text-muted" id="chat-welcome">
                                        <i class="fas fa-robot fa-3x mb-3" style="color: #C7C7CC;"></i>
                                        <p class="text-center">Model ready! Type a message below to start the conversation.</p>
                                    </div>
                                </div>
                                
                                <!-- Chat input (appears when model is loaded) -->
                                <div id="chat-input-container" class="px-3 py-2 border-top d-none">
                                    <div class="input-group">
                                        <textarea id="chat-input" class="form-control" placeholder="Type your message here... (Press Enter to send, Shift+Enter for new line)" rows="1" style="resize: none; overflow-y: hidden;"></textarea>
                                        <button class="btn btn-primary" type="button" id="send-message-btn" disabled>
                                            <i class="fas fa-paper-plane"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        

                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Loading Modal -->
    <div class="modal fade" id="loadingModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-body text-center">
                    <div class="spinner-border text-primary mb-3" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p id="loading-message">Processing...</p>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Logs Modal -->
    <div class="modal fade" id="logsModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-xl modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Training Logs</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div id="logs-content" class="bg-light p-3" style="max-height: 70vh; overflow-y: auto;"></div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" id="copy-logs-btn">
                        <i class="fas fa-copy me-2"></i>Copy to Clipboard
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Dashboard Modal -->
    <div class="modal fade" id="dashboardModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-xl" style="max-width: 90%;">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Training Dashboard</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body text-center">
                    <img id="dashboard-image" src="" class="img-fluid" alt="Training Dashboard" style="max-width: 100%;">
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Hidden file input for loading chat history -->
    <input type="file" id="load-history-file-input" accept=".json" style="display: none;">

    <!-- Loading Overlay -->
    <div id="loading-overlay" class="position-fixed top-0 start-0 w-100 h-100 bg-dark bg-opacity-50 d-flex justify-content-center align-items-center d-none" style="z-index: 1050;">
        <div class="card p-4">
            <div class="d-flex align-items-center">
                <div class="spinner-border text-primary me-3" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <div id="loading-message">Loading...</div>
            </div>
        </div>
    </div>
    
    <!-- Confirm Modal -->
    <div class="modal fade" id="confirm-modal" tabindex="-1" aria-labelledby="confirm-modal-title" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="confirm-modal-title">Confirm</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" id="confirm-modal-body">
                    Are you sure you want to proceed?
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="confirm-modal-confirm">Confirm</button>
                </div>
            </div>
        </div>
    </div>

    <!-- File Browser Modal -->
    <div class="modal fade" id="file-browser-modal" tabindex="-1" aria-labelledby="file-browser-title" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="file-browser-title">Select Directory</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="d-flex align-items-center mb-3">
                        <button type="button" class="btn btn-outline-secondary me-2" id="browser-up-btn" disabled>
                            <i class="fas fa-arrow-up"></i> Up
                        </button>
                        <div class="flex-grow-1">
                            <input type="text" class="form-control" id="browser-current-path" readonly>
                        </div>
                    </div>
                    <div id="browser-loading" class="text-center d-none">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p class="mt-2">Loading directory contents...</p>
                    </div>
                    <div id="browser-content" class="border rounded" style="height: 400px; overflow-y: auto;">
                        <!-- Directory contents will be loaded here -->
                    </div>
                    <div class="mt-3">
                        <small class="text-muted">
                            <i class="fas fa-info-circle"></i>
                            Select a directory by clicking on it, then click "Select Directory" to choose it.
                        </small>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="browser-select-btn" disabled>
                        <i class="fas fa-check"></i> Select Directory
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- Marked.js for Markdown rendering -->
    <script src="{{ url_for('static', filename='js/utils/marked.min.js') }}"></script>
    
    <!-- Custom JavaScript -->
    <script src="{{ url_for('static', filename='app.js') }}?v={{ cache_buster }}"></script>
</body>
</html> 
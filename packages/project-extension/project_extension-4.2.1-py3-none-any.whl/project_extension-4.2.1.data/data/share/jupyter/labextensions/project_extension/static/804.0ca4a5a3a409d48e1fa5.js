"use strict";(self.webpackChunkproject_extension=self.webpackChunkproject_extension||[]).push([[804],{804:(e,t,n)=>{n.r(t),n.d(t,{default:()=>w});var o=n(960),a=n(345),l=n.n(a),i=n(594),s=n(801),c=n.n(s),r=n(597);function d(e,t){var n,o,a;const l=null===(n=e.jupyterList)||void 0===n?void 0:n.find(e=>e.missionId===t.id),i=null===(o=e.progressList)||void 0===o?void 0:o.find(e=>e.missionId===t.id);return{id:t.id,key:t.id,name:t.name,title:t.name,description:t.description,path:null==l?void 0:l.path,progress:null==i?void 0:i.progress_percentage,missionId:t.id,parentId:t.parentId,isChapter:!t.parentId,children:(null===(a=e.missions.filter(e=>e.parentId===t.id))||void 0===a?void 0:a.map(t=>d(e,t)))||[]}}function p(e){const t=[],n=e.missions;return n&&n.length?(n.filter(e=>!e.parentId).forEach(n=>{const o=d(e,n);t.push(o)}),t):[]}function m(){const e=JSON.parse(r.PageConfig.getOption("env")||"{}");return console.log("Environment Config:",e),e.AUTH_URL||""}const u=({nodeData:e,valueChange:t})=>{const[n,o]=(0,a.useState)(null==e?void 0:e.title);return l().createElement("div",null,l().createElement("input",{value:n,onChange:e=>{o(e.target.value),t&&t(e.target.value)}}))};class h extends i.ReactWidget{constructor(e){super(),this.id="project-title-edit-widget",this.nodeData=e?{...e}:{name:"",title:""}}getValue(){return this.nodeData}render(){return l().createElement(u,{nodeData:this.nodeData,valueChange:e=>{this.nodeData.name=e,this.nodeData.title=e}})}}var g=n(101);const y=({documentManager:e,onItemClick:t})=>{const[n,o]=(0,a.useState)([]),[i,s]=(0,a.useState)("/"),[c,r]=(0,a.useState)("");(0,a.useEffect)(()=>{const t=new g.FileBrowserModel({manager:e});t.cd(i).then(()=>{o(Array.from(t.items()).map(e=>({name:e.name,path:e.path,type:"directory"===e.type?"directory":"file"})).filter(e=>"directory"===e.type||e.path.endsWith(".ipynb")||e.path.endsWith(".md")||e.path.endsWith(".py")||e.path.endsWith(".txt")||e.path.endsWith(".js")||e.path.endsWith(".css")||e.path.endsWith(".yml")||e.path.endsWith(".yaml")||e.path.endsWith(".xml")||e.path.endsWith(".csv")).sort((e,t)=>e.type!==t.type?"directory"===e.type?-1:1:e.name.localeCompare(t.name)))})},[e,i]);const d="/"===i?[""]:i.split("/").filter(Boolean),p=[l().createElement("span",{key:"root",style:{cursor:"/"!==i?"pointer":"default",color:"/"!==i?"#1890ff":void 0},onClick:()=>"/"!==i&&s("/")},"根目录")];let m="";return d.forEach((e,t)=>{m+="/"+e,p.push(l().createElement("span",{key:`sep-${t}`}," / "),l().createElement("span",{key:m,style:{cursor:t!==d.length-1?"pointer":"default",color:t!==d.length-1?"#1890ff":void 0},onClick:()=>{t!==d.length-1&&s(m)}},e))}),l().createElement("div",{className:"jp-filelist-widget"},l().createElement("div",{className:"jp-filelist-widget-breadcrumbs"},p),l().createElement("div",{className:"jp-filelist-widget-list-container"},n.map(e=>l().createElement("div",{key:e.path,style:{padding:"6px 12px",background:c===e.path?"#e6f7ff":"transparent",cursor:"pointer",display:"flex",alignItems:"center"},onClick:()=>{r(e.path),null==t||t(e)},onDoubleClick:()=>{"directory"===e.type&&s(e.path)}},l().createElement("span",{style:{marginRight:8}},"directory"===e.type?"📁":"📄"),l().createElement("span",null,e.name))),0===n.length&&l().createElement("div",{style:{color:"#888",padding:"12px"}},"暂无文件")))};class f extends i.ReactWidget{constructor(e){super(),this.selectedPath="",this.documentManager=e,this.id="project-file-list-widget"}getValue(){return this.selectedPath}render(){return l().createElement(y,{documentManager:this.documentManager,onItemClick:e=>{console.log(e),"directory"!==e.type?this.selectedPath=e.path:this.selectedPath=""}})}}const b="http://119.3.188.233:5173/api",v=c().create({});v.interceptors.request.use(e=>(e.headers.Authorization=`Bearer ${localStorage.getItem("sp-token")}`,console.log("---request",e),e)),v.interceptors.response.use(e=>(console.log("---response",e),e),e=>{var t;switch(console.log("---error",e),null===(t=null==e?void 0:e.response)||void 0===t?void 0:t.status){case 401:(0,i.showDialog)({title:"认证失败",body:"证失败或已过期，请重新登录!",buttons:[{label:"去登录",caption:"去登录",className:"my-button",accept:!0,displayType:"default",ariaLabel:"去登录",actions:[],iconClass:"",iconLabel:""},{label:"取消",caption:"取消",className:"my-button",accept:!0,displayType:"default",ariaLabel:"取消",actions:[],iconClass:"",iconLabel:""}],defaultButton:0,focusNodeSelector:".my-input",hasClose:!0,renderer:void 0}).then(e=>{console.log(e),console.log(" authurl",m()),"去登录"===e.button.label&&(window.location.href=m())});break;case 404:console.warn("请求资源不存在");break;case 500:console.error("服务器内部错误");break;default:console.warn("网络异常，请稍后再试")}return Promise.reject(e)});const E=e=>v.get(`${b}/projects/${e}/jupyter`).then(e=>(console.log("---getProject Missions",e),p(e.data.data))),j=(e,t)=>t.id?(console.log("---updateProjectMission",t),v.patch(`${b}/project_missions/${t.id}`,{...t}).then(e=>(console.log("---updateProjectMission",e),e.data.data))):v.post(`${b}/project_missions/`,{name:t.name,projectId:e,parentId:t.parentId}).then(e=>(console.log("---createProjectMission",e),e.data.data));function C({node:e,app:t,onNodeClick:n,onAddBelow:i,onEditName:s,onDelete:c,onLink:r}){const[d,p]=(0,a.useState)(!0),[m,u]=(0,a.useState)(""),[h,g]=(0,a.useState)(!1),y=e.children&&e.children.length>0,f=e.isChapter;return l().createElement("div",{style:{marginLeft:16}},l().createElement("div",{className:["j-chapter",e.id===m?"current":""].join(" "),style:{fontWeight:e.isChapter?"bold":"normal",fontSize:(e.isChapter,"14px")},onClick:()=>{e.path&&(u(e.id),n(e)),y&&p(e=>!e)},onMouseEnter:()=>g(!0),onMouseLeave:()=>g(!1)},l().createElement("div",{style:{display:"flex",flexDirection:"row",justifyContent:"start",alignItems:"center"}},f?l().createElement("div",{style:{display:"flex",flexDirection:"row",width:30,height:30}},y&&l().createElement("span",{style:{marginRight:4}},d?l().createElement(o.LabIcon.resolveReact,{icon:o.caretDownEmptyIcon,className:"jp-project-node-icon"}):l().createElement(o.LabIcon.resolveReact,{icon:o.caretDownEmptyIcon,className:"jp-project-node-icon rotate-90"}))):l().createElement(o.LabIcon.resolveReact,{icon:o.circleIcon,className:"jp-project-node-mini-icon"}),l().createElement("span",null," ",e.name," ")),h&&l().createElement("div",{style:{display:"flex",flexDirection:"row",justifyContent:"flex-end",alignItems:"center"}},!f&&l().createElement("div",{onClick:t=>{t.stopPropagation(),console.log("link"),r(e)}},l().createElement(o.LabIcon.resolveReact,{icon:o.linkIcon,className:"jp-project-node-icon"})),l().createElement("div",{onClick:t=>{t.stopPropagation(),console.log("editname"),s(e)}},l().createElement(o.LabIcon.resolveReact,{icon:o.editIcon,className:"jp-project-node-icon"})),f&&l().createElement("div",{onClick:t=>{t.stopPropagation(),console.log("click"),i(e)}},l().createElement(o.LabIcon.resolveReact,{icon:o.addBelowIcon,className:"jp-project-node-icon"})),l().createElement("div",{onClick:t=>{t.stopPropagation(),console.log("click"),c(e)}},l().createElement(o.LabIcon.resolveReact,{icon:o.deleteIcon,className:"jp-project-node-icon"})))),y&&d&&l().createElement("div",null,e.children.map(e=>l().createElement(C,{key:e.id,app:t,node:e,onNodeClick:n,onAddBelow:i,onEditName:s,onDelete:c,onLink:r}))))}function I({projectId:e,app:t,documentManager:n}){const[s,c]=(0,a.useState)([]),[r,d]=(0,a.useState)(!0);(0,a.useEffect)(()=>{E(e).then(e=>{c(e),d(!1)})},[]);const p=e=>{e.path&&t.commands&&(console.log("---open::",e.path),t.commands.execute("docmanager:open",{path:e.path}))},m=t=>{(function(e){return(0,i.showDialog)({title:(null==e?void 0:e.missionId)?"编辑子任务":"添加子任务",body:new h(e),buttons:[{label:"确定",caption:"确定",className:"my-button",accept:!0,displayType:"default",ariaLabel:"确定",actions:[],iconClass:"",iconLabel:""},{label:"取消",caption:"取消",className:"j-project-create-dialog-button",accept:!1,displayType:"default",ariaLabel:"取消",actions:[],iconClass:"",iconLabel:""}],defaultButton:0,focusNodeSelector:".my-input",hasClose:!0,renderer:void 0})})(t).then(({button:t,value:n})=>{var o;console.log("showEditTaskDialog:",n),n?"确定"===t.label&&(null===(o=j(e,n))||void 0===o||o.then(()=>{E(e).then(e=>{c(e),d(!1)})})):(0,i.showErrorMessage)("错误","输入内容为空")})},u=()=>{console.log("showDialog"),e?(0,i.showDialog)({title:"新增章节",body:new h,host:document.body,buttons:[{label:"确定",caption:"确定",className:"my-button",accept:!0,displayType:"default",ariaLabel:"确定",actions:[],iconClass:"",iconLabel:""},{label:"取消",caption:"取消",className:"j-project-create-dialog-button",accept:!1,displayType:"default",ariaLabel:"取消",actions:[],iconClass:"",iconLabel:""}],defaultButton:0,focusNodeSelector:".my-input",hasClose:!0,renderer:void 0}).then(({value:t})=>{var n;t?null===(n=j(e,t))||void 0===n||n.then(()=>{E(e).then(e=>{c(e),d(!1)})}):(0,i.showErrorMessage)("错误","输入内容为空")}):(0,i.showErrorMessage)("错误","项目不存在")};return l().createElement(l().Fragment,null,l().createElement("div",{style:{display:"flex",flexDirection:"row",justifyContent:"flex-end",padding:"0px 10px",backgroundColor:"#f5f5f5",borderBottom:"1px solid #ddd"}},l().createElement("button",{className:"jp-ToolbarButton jp-mod-styled flex-center",onClick:u},l().createElement(o.LabIcon.resolveReact,{icon:o.newFolderIcon,className:"flex-center"}),l().createElement("div",{style:{marginLeft:"5px"}},"新建章节"))),l().createElement("div",{className:"sidebar-content"},r?l().createElement("div",null,"加载中..."):l().createElement(l().Fragment,null,s.length>0?s.map(o=>l().createElement(C,{key:o.id,app:t,node:o,onNodeClick:p,onEditName:e=>{m(e)},onDelete:t=>{var n;(function(e){return(0,i.showDialog)({title:"删除项目步骤",body:`确定删除项目步骤：${null==e?void 0:e.name}`,buttons:[{label:"确定",caption:"确定",className:"my-button",accept:!0,displayType:"default",ariaLabel:"确定",actions:[],iconClass:"",iconLabel:""}],defaultButton:0,focusNodeSelector:".my-input",hasClose:!0,renderer:void 0})})(n=t).then(()=>{var t;(t=n.id,v.delete(`${b}/project_missions/${t}`).then(e=>(console.log("---deleteProjectMission",e),e.data.data))).then(()=>{E(e).then(e=>{c(e),d(!1)})})})},onLink:t=>{var o;o=t,async function(e){return(0,i.showDialog)({title:"选择文件",body:new f(e),buttons:[i.Dialog.cancelButton(),i.Dialog.okButton({label:"选择"})]})}(n).then(t=>{if("选择"===t.button.label){const a=t.value;console.log("---linkL:",t),(n={missionId:o.id,path:a},v.post(`${b}/jupyters`,{missionId:n.missionId,path:n.path})).then(()=>{E(e).then(e=>{c(e),d(!1)})})}var n})},onAddBelow:e=>{m({id:"",key:"",name:"",parentId:e.id,missionId:"",title:"",description:"",path:"",isChapter:!1,progress:0,children:[]})}})):l().createElement("div",{className:"j-project-empty-container"},l().createElement("div",{className:"j-project-empty-text"},"暂无内容"),l().createElement("button",{className:"j-project-create-button",onClick:()=>u()},"新建章节")))))}class k extends o.ReactWidget{constructor(e,t){super(),this.id="project-sidebar",this.addClass("project-sidebar-widget"),this.title.closable=!0,this.title.iconLabel="项目步骤",this.title.caption="打开项目步骤",this.app=e,this.documentManager=t;const n=JSON.parse(r.PageConfig.getOption("env")||"{}");console.log("Environment Config:",n),window.pageConfig=r.PageConfig;const o=n.PROJECT_ID||"";this.projectId=o}render(){return l().createElement(I,{app:this.app,projectId:this.projectId,documentManager:this.documentManager})}}const w={id:"project_extension:plugin",description:"项目步骤",autoStart:!0,requires:[n(148).IDocumentManager],activate:(e,t)=>{const{commands:n}=e,o=new k(e,t);e.shell.add(o,"left",{rank:10,activate:!0}),console.log("Project sidebar widget added to the application shell."),e.restored.then(()=>{console.log("JupyterLab application restored."),e.shell.activateById(o.id)}),n.addCommand("project-sidebar:open-file",{label:"打开文件",caption:"打开文件",execute:e=>{const t=e.path;t?n.execute("docmanager:open",{path:t}):console.error("No file path specified")}})}}}}]);
---
name: ezbak
services:
    ezbak:
        image: python:3.13-slim-bookworm
        build:
            context: _ROOT_DIR_
            dockerfile: Dockerfile
        container_name: ezbak
        environment:
            - TZ=America/New_York
            # Required Settings
            # ---------------------------
            - EZBAK_ACTION=backup
            - EZBAK_NAME=test
            - EZBAK_SOURCE_PATHS=/source/project1,/source/project2
            - EZBAK_STORAGE_PATHS=/backups
            - EZBAK_STORAGE_LOCATION=local

            # Backup Options
            # ---------------------------
            - EZBAK_STRIP_SOURCE_PATHS=false
            - EZBAK_DELETE_SRC_AFTER_BACKUP=false
            - EZBAK_EXCLUDE_REGEX=
            - EZBAK_INCLUDE_REGEX=
            - EZBAK_COMPRESSION_LEVEL=6
            - EZBAK_LABEL_TIME_UNITS=true
            - EZBAK_RENAME_FILES=false

            # Retention Policies
            # ---------------------------
            - EZBAK_MAX_BACKUPS=4
            - EZBAK_RETENTION_YEARLY=4
            - EZBAK_RETENTION_MONTHLY=4
            - EZBAK_RETENTION_WEEKLY=4
            - EZBAK_RETENTION_DAILY=4
            - EZBAK_RETENTION_HOURLY=4
            - EZBAK_RETENTION_MINUTELY=4

            # Scheduling
            # ---------------------------
            # - EZBAK_CRON=*/1 * * * *
            - EZBAK_TZ=America/New_York

            # Logging
            # ---------------------------
            - EZBAK_LOG_LEVEL=TRACE
            - EZBAK_LOG_FILE=/logs/ezbak.log
            - EZBAK_LOG_PREFIX=docker

            # Restore
            # ---------------------------
            - EZBAK_RESTORE_PATH=/restore
            - EZBAK_CLEAN_BEFORE_RESTORE=true
            # - EZBAK_CHOWN_UID=
            # - EZBAK_CHOWN_GID=

            # AWS Storage Backend
            # ---------------------------
            # - EZBAK_AWS_ACCESS_KEY=
            # - EZBAK_AWS_SECRET_KEY=
            # - EZBAK_AWS_S3_BUCKET_NAME=
            # - EZBAK_AWS_S3_BUCKET_PATH=

        volumes:
            - ./source:/source
            - ./backups:/backups
            - ./logs:/logs
            - ./restore:/restore
        develop:
            watch:
                - action: sync+restart
                  path: _ROOT_DIR_/src/
                  target: /app/src/
                  ignore:
                      - .git/
                      - .github/
                      - .dev/
                - action: rebuild
                  path: _ROOT_DIR_/uv.lock
                  target: /app/uv.lock
                - action: rebuild
                  path: _ROOT_DIR_/pyproject.toml
                  target: /app/pyproject.toml
                - action: rebuild
                  path: _ROOT_DIR_/Dockerfile

---
name: Nightly Build
on:  # yamllint disable-line rule:truthy
  workflow_dispatch:
  schedule:
    - cron: '0 1 * * *'  # 1:00am UTC/9:00pm PST aligned with Kumo docker image builds
jobs:
  dist:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository and submodules
        uses: actions/checkout@v4
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.9'
      - name: Set version
        run: |
          VERSION_NUM=$(grep 'version=' pyproject.toml | head -1 | cut -d'"' -f2)
          echo "Extracted version: $VERSION_NUM"
          echo "VERSION_NUM=$VERSION_NUM" >> $GITHUB_ENV
      - name: Set time
        run: |
          LA_DATE=$(TZ='America/Los_Angeles' date +'%Y%m%d')
          echo "TODAY=$LA_DATE" >> $GITHUB_ENV
          echo "Using LA date: $LA_DATE"
      - name: Set nightly version
        run: echo "VERSION_TODAY=${{ env.VERSION_NUM }}.dev${{ env.TODAY }}" >> $GITHUB_ENV
      - name: Customize build version
        run: |
          echo "Setting version to ${{ env.VERSION_TODAY }}"
          sed -i -E "s/version=\"[^\"]*\"/version=\"${{env.VERSION_TODAY}}\"/g" pyproject.toml
          sed -i -E "s/__version__ = '[^']*'/__version__ = '${{env.VERSION_TODAY}}'/g" kumoai/__init__.py
      - name: Build wheel
        run: |
          python -m pip install build
          python3 -m build
          WHEEL_PATH="dist/$(ls dist | grep '.*.whl')"
          echo "WHEEL_PATH=$WHEEL_PATH" >> $GITHUB_ENV
        env:
          GITHUB_TOKEN: ${{secrets.KUMO_GITHUB_BOT_TOKEN}}
      - name: Upload wheel
        run: |
          prefix="s3://kumo-sdk/packages"
          aws s3 cp "${{ env.WHEEL_PATH }}" "$prefix/latest/kumoai-${{ env.VERSION_NUM }}-py3-none-any.whl"
          aws s3 cp "${{ env.WHEEL_PATH }}" "$prefix/nightly/kumoai-${{ env.VERSION_TODAY }}-py3-none-any.whl"
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          AWS_DEFAULT_REGION: us-west-2

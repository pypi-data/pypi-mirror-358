{
    "$schema": "http://json-schema.org/draft-07/schema#",
    "title": "Filter definitions",
    "description": "Independent file for filter description.",
    "type": "object",
    "required": [ "format_version"],
    "properties": {
        "format_version" : {"$ref" : "#/format_version"},
        "revision" :       {"$ref" : "definitions.schema.json#/revision"},
        "yaml_anchors" :   {"$ref" : "definitions.schema.json#/yaml_anchors"},
        "notes" :          {"$ref": "definitions.schema.json#/note_list"},
        "filter" :         {"$ref" : "#/definitions/filter"}
    },
    "additionalProperties" : false,
    "format_version" : {
        "type": "string",
        "anyOf": [
            {"pattern": "^1\\.0$"},
            {"$ref": "definitions.schema.json#/format_version"}
        ]
    },
    "definitions": {
       "filter": {
            "type" : "object",
            "required" : ["type"],
            "properties": {
                "type": {
                    "enum": [
                        "PolesZeros",
                        "FIR",
                        "Coefficients",
                        "ResponseList",
                        "Polynomial",
                        "ADCONVERSION",
                        "ANALOG",
                        "DIGITAL"
                    ]
                },
                "resource_id":        {"$ref": "definitions.schema.json#resource_id"},
                "custom_fields":     {"$ref": "definitions.schema.json#custom_fields"}
            },
            "if": {
                "properties": {"type": {"const": "PolesZeros"}},
                "required": ["type"]
            },
            "then": {"$ref": "#/definitions/POLESZEROS"},
            "else": { 
                "if": {
                    "properties": {"type": {"const": "FIR"}},
                    "required": ["type"]
                },
                "then": {"$ref": "#/definitions/FIR"},
                "else": { 
                    "if": {
                        "properties": {"type": {"const": "Coefficients"}},
                        "required": ["type"]
                    },
                    "then": {"$ref": "#/definitions/COEFFICIENTS"},
                    "else": {
                        "if": {
                            "properties": {"type": {"const": "ResponseList"}},
                            "required": ["type"]
                        },
                        "then": {"$ref": "#/definitions/RESPONSELIST"},
                        "else": {
                            "if": {
                                "properties": {"type": {"const": "Polynomial"}},
                                "required": ["type"]
                            },
                            "then": {"$ref": "#/definitions/POLYNOMIAL"},
                            "else": {
                                "if": {
                                    "properties": {"type": {"const": "ADCONVERSION"}},
                                    "required": ["type"]
                                },
                                "then": {"$ref": "#/definitions/ADCONVERSION"},
                                "else": {
                                    "if": {
                                        "properties": {"type": {"const": "ANALOG"}},
                                        "required": ["type"]
                                    },
                                    "then": {"$ref": "#/definitions/ANALOG"},
                                    "else": {
                                        "if": {
                                            "properties": {"type": {"const": "DIGITAL"}},
                                            "required": ["type"]
                                        },
                                        "then": {"$ref": "#/definitions/DIGITAL"}
                                    }
                                }
                            }
                        }
                    }
                 }
             }
        },
        "POLESZEROS": {
            "type" : "object",
            "description" : "Poles-zeros response formulation",
            "required" : ["type", "poles", "zeros"],
            "properties": {
                "type":                    {"enum": ["PolesZeros"] },
                "poles":                   {"$ref": "#/definitions/pole_list"},
                "zeros":                   {"$ref": "#/definitions/zero_list"},
                "delay.seconds":           {"type": "number"},
                "transfer_function_type":  {"$ref": "#/definitions/pz_units"},
                "normalization_frequency": {"$ref": "#/definitions/norm_freq"},
                "normalization_factor":    {"$ref": "#/definitions/norm_fact"},
                "resource_id":             {"type": "string"}
            },
            "additionalProperties": false
        },
        "FIR": {
            "type" : "object",
            "description" : "FIR response formulation",
            "required": ["type", "symmetry", "coefficients", "delay.samples"],
            "properties" : {
                "type":                 {"enum": ["FIR"] },
                "symmetry":             {"$ref": "#/definitions/symmetry"},
                "coefficient_divisor":  {"type": "number", "description": "number to divide coefficients by to get sum=1"},
                "coefficients":         {"$ref": "#/definitions/coefficient_list"},
                "delay.samples":        {"type": "number"},
                "resource_id":          {"type": "string"}
            },
            "additionalProperties": false
        },
        "COEFFICIENTS": {
            "type" : "object",
            "description" : "Coefficients response formulation (often used for IIRs)",
            "required" : ["type", "numerator_coefficients", "denominator_coefficients"],
            "properties" : {
                "type":                     {"enum": ["Coefficients"]},
                "numerator_coefficients":   {"$ref": "#/definitions/coefficient_list"},
                "denominator_coefficients": {"$ref": "#/definitions/coefficient_list"},
                "delay.samples":            {"type": "number"},
                "transfer_function_type":   {"$ref": "#/definitions/coefficients_transfer_function_type"},
                "resource_id":              {"type": "string"}
            },
            "additionalProperties": false
        },
        "RESPONSELIST": {
            "type" : "object",
            "description" : "Response list formulation",
            "required" : [ "type", "elements"],
            "properties" : {
                "type":           {"enum": ["ResponseList"]},
                "elements":       {"$ref": "#/definitions/response_element_list"},
                "delay.seconds":  {"type": "number"},
                "resource_id":    {"type": "string"}
            },
            "additionalProperties": false
        },
        "POLYNOMIAL": {
            "type": "object",
            "description": "NEVER TESTED",
            "required": ["type", "coefficients", "frequency_lower_bound",
                         "frequency_upper_bound", "approximation_lower_bound",
                         "approximation_upper_bound", "maximum_error"],
            "properties": {
                "type": {"enum": ["Polynomial"]},
                "coefficients": {"$ref": "#/definitions/polynomial_coefficients_list"},
                "frequency_lower_bound": {"$ref": "#/definitions/frequency_bound"},
                "frequency_upper_bound": {"$ref": "#/definitions/frequency_bound"},
                "approximation_lower_bound": {"type": "number"},
                "approximation_upper_bound": {"type": "number"},
                "maximum_error": {"type": "number"},
                "approximation_type": {"enum": ["MACLAURIN"]},
                "resource_id": {"type": "string"}
            },
            "additionalProperties": false
        },
        "ADCONVERSION": {
            "type": "object",
            "description": "A/D specifics",
            "required": ["type", "v_minus", "v_plus",
                         "counts_minus", "counts_plus"],
            "properties" : {
                "type":              {"enum": ["ADCONVERSION"]},
                "delay.samples":     {"type": "number"},
                "v_minus":           {"type": "number"},
                "v_plus":            {"type": "number"},
                "counts_minus":      {"type": ["number", "string"]},
                "counts_plus":       {"type": ["number", "string"]},
                "counts_dtype":      {"type": "string",
                                      "enum": ["int16", "int24", "int32", "int64",
                                               "uint16", "uint24", "uint32", "uint64"]
                                     },
                "resource_id":       {"type": "string"}
            },
            "additionalProperties": false
        },
        "ANALOG": {
            "type": "object",
            "description": "ANALOG filter (map into PoleZeros with no poles or zeros)",
            "required": ["type"],
            "properties" : {
                "type": {"enum": ["ANALOG"]},
                "delay.seconds": {"type": "number"},
                "resource_id": {"type": "string"}
            },
            "additionalProperties": false
        },
        "DIGITAL": {
            "type": "object",
            "description": "DIGITAL filter (map into Coefficients with no coefficients)",
            "required": ["type"],
            "properties" : {
                "type": {"enum": ["DIGITAL"]},
                "delay.samples": {"type": "number"},
                "resource_id": {"type": "string"}
            },
            "additionalProperties": false
        },
        "filter_wo_required_fields": {
             "type" : "object",
             "description" : "Generic filter for attribute modifications in channel_modifications",
             "properties": {
                "type":                    {"enum": ["PolesZeros", "FIR", "Coefficients", "ResponseList", "ADCONVERSION", "ANALOG", "DIGITAL"]},
                "delay.samples":           {"type": "number"},
                "delay.seconds":           {"type": "number"},
                "transfer_function_type":  {"$ref": "#/definitions/pz_units"},
                "normalization_frequency": {"$ref": "#/definitions/norm_freq"},
                "normalization_factor":    {"$ref": "#/definitions/norm_fact"},
                "poles":                   {"$ref": "#/definitions/pole_list"},
                "zeros":                   {"$ref": "#/definitions/zero_list"},
                "symmetry":                {"$ref": "#/definitions/symmetry"},
                "coefficient_divisor":     {"type": "number"},
                "coefficients":            {"$ref": "#/definitions/coefficient_list"},
                "numerator_coefficients":  {"$ref": "#/definitions/coefficient_list"},
                "denominator_coefficients":{"$ref": "#/definitions/coefficient_list"},
                "elements":                {"$ref": "#/definitions/response_element_list"}, 
                "input_full_scale":        {"$ref": "#/definitions/AD_full_scale"},
                "output_full_scale":       {"$ref": "#/definitions/AD_full_scale"},
                "resource_id":             {"type": "string"}
             },
             "additionalProperties": false        
        },
        "pz_units": {
            "type" : "string",
            "enum" : ["LAPLACE (RADIANS/SECOND)", "LAPLACE (HERTZ)", "DIGITAL (Z-TRANSFORM)"],
            "default" : "LAPLACE (RADIANS/SECOND)"
        },
        "norm_freq": {
            "type": "number",
            "description": "If undefined, will use gain:frequency",
            "minimum" : 0.0
        },
        "norm_fact": {
            "type": "number",
            "description": "If undefined, will be calculated from normalization_frequency and poles and zeros",
            "minimum" : 0.0
        },
        "pole_list": {
            "description": "Instrument poles (rad/s)",
            "type": "array",
            "items": { "$ref" : "#/definitions/complex_number"}
        },
        "zero_list": {
            "description": "Instrument zeros (rad/s)",
            "type": "array",
            "items": { "$ref" : "#/definitions/complex_number"}
        },
        "complex_number": {
            "type": "string",
            "description": "complex number as x + yj",
            "pattern": "^[+-]?(([0-9]+\\.[0-9]*|[0-9]*\\.[0-9]+|[0-9]+)[ ]*[+-][ ]*([0-9]+\\.[0-9]*|[0-9]*\\.[0-9]+|[0-9]+)j)|[+-]?([0-9]+\\.[0-9]*|[0-9]*\\.[0-9]+|[0-9]+)j"
        },
        "symmetry": {
            "type": "string",
            "enum": ["NONE", "EVEN", "ODD"]
        },
        "coefficient_list": {
            "type": "array",
            "minItems": 0,
            "items" : { "type" : "number" }
        },
        "coefficients_transfer_function_type": {
            "type" : "string",
            "enum" : [ "ANALOG (RADIANS/SECOND)", "ANALOG (HERTZ)", "DIGITAL"]
        },
        "polynomial_coefficients_list": {
            "type" : "array",
            "minItems": 2,
            "items" : { "$ref" : "#/definitions/polynomial_coefficient"}
        },
        "polynomial_coefficient": {
             "type" : "object",
             "description" : "Polynomial filter coefficient",
             "required": ["value"],
             "properties": {
                "value":                   {"type": "number"},
                "plus_error":              {"type": "number"},
                "minus_error":             {"type": "number"},
                "measurement_method":      {"type": "string"},
                "number":                  {"type": "integer", "minimum": 0}
             },
             "additionalProperties": false        
        },
        "frequency_bound": {
             "type" : "object",
             "description" : "Upper or lower frequency bound",
             "required": ["value"],
             "properties": {
                "value":                   {"type": "number"},
                "unit":                    {"type": "string", "enum": ["HERTZ"]},
                "plus_error":              {"type": "number"},
                "minus_error":             {"type": "number"},
                "measurement_method":      {"type": "string"}
             },
             "additionalProperties": false        
        },
        "response_element_list": {
            "type" : "array",
            "items" : {
                "type" : "array",
                "description" : "[frequency (Hz), amplitude, phase (degrees)]",
                "minItems": 3,
                "maxItems": 3,
                "items": {"type": "number"}
            }
        },
        "AD_full_scale": {
            "type": "number",
            "description": "Used for ADCONVERSION, ..."
        }
    }
}

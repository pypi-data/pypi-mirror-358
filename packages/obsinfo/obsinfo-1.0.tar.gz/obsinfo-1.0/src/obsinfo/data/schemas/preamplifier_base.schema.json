{
    "$schema": "http://json-schema.org/draft-07/schema#",
    "title": "Instrument Components",
    "description": "OBS operator instrument components",
    "type": "object",
    "required": ["format_version", "preamplifier_base"],
    "properties": {
        "format_version":    {"$ref": "definitions.schema.json#/format_version"},
        "revision":          {"$ref": "definitions.schema.json#/revision"},
        "yaml_anchors":      {"$ref": "definitions.schema.json#/yaml_anchors"},
        "notes" :            {"$ref": "definitions.schema.json#/note_list"},
        "preamplifier_base": {"$ref": "#/definitions/base" }
    },
    "additionalProperties" : false,
    "definitions": {
        "common_properties": {
            "description": "list of common properties in {element}, modifications, base, definition, and configuration_definition.  This is unused because 'allOf' for makes ugly schema validation",
            "properties": {
                "notes":                  {"$ref": "definitions.schema.json#/note_list"},
                "equipment":              {"$ref": "definitions.schema.json#/equipment"},
                "stages":                 {"$ref": "stages.schema.json#/definitions/stages"},
                "stage_modifications":    {"$ref": "stages.schema.json#/definitions/stage_modifications"}
            }
        },
        "preamplifier" : {
            "description" : "preamplifier definition (base+configuration)",
            "type": "object",
            "required": ["base"],
            "properties": {
                "base":                    {"$ref" : "#/definitions/base" },
                "configuration":           {"type": ["string", "null"]},
                "modifications":           {"$ref": "#/definitions/modifications"},
                "stage_modifications":     {"$ref": "stages.schema.json#/definitions/stage_modifications"},
                "notes" :                  {"$ref": "definitions.schema.json#/note_list"},
                
                "serial_number":           {"type": "string"}
            },
            "additionalProperties" : false
        },
        "modifications" : {
            "description" : "preamplifier modifications, same as definition except base not required",
            "type": "object",
            "properties": {
                "base":                    {"$ref" : "#/definitions/base" },
                "configuration":           {"type": ["string", "null"]},
                "serial_number":           {"type": "string"}, 

                "equipment":              {"$ref": "definitions.schema.json#/equipment"},
                "stages":                 {"$ref": "stages.schema.json#/definitions/stages"},
                "notes":                  {"$ref": "definitions.schema.json#/note_list"},
                "stage_modifications":    {"$ref": "stages.schema.json#/definitions/stage_modifications"}
            },
            "additionalProperties" : false
        },
        "base" : {
            "description": "Preamplifier specification",
            "required": ["equipment",
                         "stages"],
            "properties": {
                "equipment":              {"$ref": "definitions.schema.json#/equipment"},
                "stages":                 {"$ref": "stages.schema.json#/definitions/stages"},
                "notes":                  {"$ref": "definitions.schema.json#/note_list"},
                "stage_modifications":    {"$ref": "stages.schema.json#/definitions/stage_modifications"},
                "configuration_default":  {"type": "string"},
                "configurations":         {"$ref": "#/definitions/configurations_map"}
            },
            "additionalProperties": false
        },
        "configurations_map": {
            "description": "Map of configuration names",
            "patternProperties": {
                "^[A-Za-z0-9_-]+$": {"$ref": "#/definitions/configuration_definition"}
            }
        },
        "configuration_definition" : {
            "description": "Configuration-specific properties",
            "properties": {
                "configuration_description": {"type": "string"},

                "notes":                  {"$ref": "definitions.schema.json#/note_list"},
                "equipment":              {"$ref": "definitions.schema.json#/equipment"},
                "stages":                 {"$ref": "stages.schema.json#/definitions/stages"},
                "stage_modifications":    {"$ref": "stages.schema.json#/definitions/stage_modifications"}
            },
            "additionalProperties": false
        }
    }
}
